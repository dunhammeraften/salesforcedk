<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>63.0</apiVersion>
    <areMetricsLoggedToDataCloud>false</areMetricsLoggedToDataCloud>
    <assignments>
        <description>Assign subscriptionRecordToActOn variable.</description>
        <name>Store_Subscription_To_Delete</name>
        <label>Store Subscription To Delete</label>
        <locationX>578</locationX>
        <locationY>539</locationY>
        <assignmentItems>
            <assignToReference>subscriptionRecordToActOn</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Delete_Redundant_Subscription</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>Assign subscriptionRecordToActOn variable.</description>
        <name>Store_Subscription_To_Update</name>
        <label>Store Subscription To Update</label>
        <locationX>50</locationX>
        <locationY>539</locationY>
        <assignmentItems>
            <assignToReference>subscriptionRecordToActOn</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>subscriptionRecordToActOn.To_Delete__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Switch_To_Delete_Flag</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Sibling_Was_Found</name>
        <label>Sibling Was Found</label>
        <locationX>314</locationX>
        <locationY>431</locationY>
        <defaultConnector>
            <targetReference>Store_Subscription_To_Delete</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Not found</defaultConnectorLabel>
        <rules>
            <name>Found</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Sibling_Subscription</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Store_Subscription_To_Update</targetReference>
            </connector>
            <label>Found</label>
        </rules>
    </decisions>
    <description>When a Subscription record is marked To Delete, then we want to delete it if there are no sibling Subscriptions with a Root Id that points to exactly the incoming Subscription. (DKT-42662).</description>
    <environments>Default</environments>
    <formulas>
        <name>errorBodyDeleteFormula</name>
        <dataType>String</dataType>
        <expression>&apos;Delete failed for the Container Subscription Id &apos; + {!subscriptionRecordToActOn.Id}</expression>
    </formulas>
    <formulas>
        <name>errorBodyUpdateFormula</name>
        <dataType>String</dataType>
        <expression>&apos;Update failed for Container Subscription Id &apos; + {!subscriptionRecordToActOn.Id} + &apos; (We tried to switch the To Delete flag back to FALSE)&apos;</expression>
    </formulas>
    <formulas>
        <name>sanityIdOfRecordToDelete</name>
        <dataType>String</dataType>
        <expression>&apos;Kirstine, record to delete id: &apos; + {!$Record.Id} + &apos;:END&apos;</expression>
    </formulas>
    <interviewLabel>Subscription: Delete Redundant Subscription {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Subscription: Delete Redundant Subscription</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordCreates>
        <name>System_Log_on_Delete</name>
        <label>System Log on Delete</label>
        <locationX>842</locationX>
        <locationY>755</locationY>
        <inputAssignments>
            <field>Additional_Information__c</field>
            <value>
                <stringValue>Subscription_Delete_Redundant_Subscription</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Error_Body__c</field>
            <value>
                <elementReference>errorBodyDeleteFormula</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Origin__c</field>
            <value>
                <stringValue>Flow</stringValue>
            </value>
        </inputAssignments>
        <object>System_Log__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordCreates>
    <recordCreates>
        <name>System_Log_on_Update</name>
        <label>System Log on Update</label>
        <locationX>314</locationX>
        <locationY>755</locationY>
        <inputAssignments>
            <field>Additional_Information__c</field>
            <value>
                <stringValue>Subscription_Delete_Redundant_Subscription</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Error_Body__c</field>
            <value>
                <elementReference>errorBodyUpdateFormula</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Origin__c</field>
            <value>
                <stringValue>Flow</stringValue>
            </value>
        </inputAssignments>
        <object>System_Log__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordCreates>
    <recordDeletes>
        <description>The triggering Subscription has no sibling Subscriptions with Root Id pointing to it. We can therefore go ahead and delete the triggering Subscription.</description>
        <name>Delete_Redundant_Subscription</name>
        <label>Delete Redundant Subscription</label>
        <locationX>578</locationX>
        <locationY>647</locationY>
        <faultConnector>
            <targetReference>System_Log_on_Delete</targetReference>
        </faultConnector>
        <inputReference>subscriptionRecordToActOn</inputReference>
    </recordDeletes>
    <recordLookups>
        <description>Get Sibling Subscriptions under the same Contract as the triggering Subscription, but only the ones where their Root Id equals the Id of the triggering Subscription. Only return the first found record.</description>
        <name>Get_Sibling_Subscription</name>
        <label>Get Sibling Subscription</label>
        <locationX>314</locationX>
        <locationY>323</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Sibling_Was_Found</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>SBQQ__Contract__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.SBQQ__Contract__c</elementReference>
            </value>
        </filters>
        <filters>
            <field>Id</field>
            <operator>NotEqualTo</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>SBQQ__RootId__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>SBQQ__Subscription__c</object>
        <queriedFields>Id</queriedFields>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <description>Update To Delete to False.</description>
        <name>Switch_To_Delete_Flag</name>
        <label>Switch To Delete Flag</label>
        <locationX>50</locationX>
        <locationY>647</locationY>
        <faultConnector>
            <targetReference>System_Log_on_Update</targetReference>
        </faultConnector>
        <inputReference>subscriptionRecordToActOn</inputReference>
    </recordUpdates>
    <start>
        <locationX>188</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Get_Sibling_Subscription</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>To_Delete__c</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>SBQQ__ProductOption__c</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>To_Delete__c</field>
            <operator>IsChanged</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <object>SBQQ__Subscription__c</object>
        <recordTriggerType>Update</recordTriggerType>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
    <variables>
        <name>subscriptionRecordToActOn</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>SBQQ__Subscription__c</objectType>
    </variables>
</Flow>
